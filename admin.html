<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>HDR - Admin</title>

  <!-- Favicon - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
  <link rel="icon" type="image/x-icon"
    href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">
  <link rel="shortcut icon" href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">
  <link rel="apple-touch-icon"
    href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

  <style>
    :root {
      --sidebar-width: 280px;
      --font-main: 'Kanit', sans-serif;

      /* New Premium Palette (Deep Space & Nebula) */
      --bg-body: #020617;
      /* Slate 950 */
      --bg-sidebar: rgba(15, 23, 42, 0.95);
      /* Slate 900 - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      --bg-card: rgba(30, 41, 59, 0.6);
      /* Slate 800 */
      --bg-input: rgba(2, 6, 23, 0.5);

      --primary: #6366f1;
      /* Indigo 500 */
      --primary-dark: #4f46e5;
      /* Indigo 600 */
      --primary-glow: rgba(99, 102, 241, 0.5);

      --accent: #06b6d4;
      /* Cyan 500 */
      --accent-glow: rgba(6, 182, 212, 0.5);

      --success: #10b981;
      /* Emerald 500 */
      --danger: #f43f5e;
      /* Rose 500 */
      --warning: #f59e0b;
      /* Amber 500 */

      --text-main: #f8fafc;
      /* Slate 50 */
      --text-muted: #94a3b8;
      /* Slate 400 */

      --border-color: rgba(148, 163, 184, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.08);

      --radius-xl: 24px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;

      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
      --glow-card: 0 0 0 1px rgba(255, 255, 255, 0.05), 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      outline: none;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      display: flex;
      position: relative;
    }

    /* Ambient Background Effect - Cleaner & "Cool" */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.08) 0%, transparent 40%);
      z-index: -1;
      pointer-events: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.4);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: var(--glass-border);
      display: flex;
      flex-direction: column;
      padding: 2rem 1.5rem;
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 5px 0 30px rgba(0, 0, 0, 0.2);
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞ iPad */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        box-shadow: none;
      }

      .sidebar.show {
        transform: translateX(0);
        box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
      }

      .main-content {
        margin-left: 0 !important;
        padding: 5rem 1rem !important;
        width: 100%;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      #mobileMenuBtn {
        display: flex !important;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: var(--bg-card);
        border: var(--glass-border);
        color: var(--text-main);
        width: 48px;
        height: 48px;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        font-size: 1.5rem;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.2s;
      }

      #mobileMenuBtn:active {
        transform: scale(0.95);
        background: rgba(99, 102, 241, 0.2);
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å */
      #loggedInBackButton {
        top: 15px !important;
        right: 15px !important;
        z-index: 1001 !important;
      }

      #loggedInBackButton button {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 8px 16px;
        font-size: 0.9rem;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
      .card {
        padding: 1.25rem !important;
        margin-bottom: 1.25rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
        gap: 0.75rem !important;
      }

      .room-card {
        padding: 1rem !important;
      }

      .room-card .val {
        font-size: 1.8rem !important;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ */
      .table-container {
        border-radius: var(--radius-md);
        margin: 0 -0.25rem;
        width: calc(100% + 0.5rem);
      }

      table {
        min-width: 600px;
      }

      th, td {
        padding: 12px 16px !important;
        font-size: 0.9rem;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
      td .btn-icon-round {
        width: 34px;
        height: 34px;
        font-size: 0.9rem;
      }

      td {
        flex-wrap: wrap;
        gap: 6px !important;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
      #editForm {
        padding: 1.25rem !important;
      }

      #editForm > div:first-of-type {
        grid-template-columns: 1fr !important;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á date selector */
      .date-selector {
        padding: 1rem !important;
        gap: 15px !important;
      }

      .date-input-group {
        width: 100%;
      }

      .btn-summary {
        width: 100%;
        padding: 14px !important;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á search box */
      #manage .card > div:first-of-type {
        grid-template-columns: 1fr !important;
      }

      /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á login panel */
      #loginPanel .card {
        padding: 2rem 1.5rem !important;
        max-width: 90% !important;
      }

      .login-back-button button {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPad ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .main-content {
        padding: 5rem 2rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(4, 1fr) !important;
      }
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å */
    @media (max-width: 480px) {
      .main-content {
        padding: 5rem 0.75rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .section-header button {
        width: 100%;
      }

      h2 {
        font-size: 1.5rem !important;
      }

      .card {
        padding: 1rem !important;
      }

      .btn-summary {
        font-size: 1rem !important;
      }

      td {
        font-size: 0.85rem !important;
        padding: 10px 12px !important;
      }

      td .btn-icon-round {
        width: 30px;
        height: 30px;
      }

      .badge-absent, .badge-present {
        padding: 4px 10px !important;
        font-size: 0.75rem !important;
      }
    }

    /* ‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Desktop Styles */
    @media (min-width: 1025px) {
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 3rem;
      }

      #mobileMenuBtn {
        display: none !important;
      }

      .sidebar-overlay {
        display: none !important;
      }
    }

    .sidebar-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 3rem;
      padding-left: 0.5rem;
      letter-spacing: 0.5px;
    }

    .sidebar-header i {
      font-size: 1.8rem;
      color: var(--primary);
      filter: drop-shadow(0 0 10px var(--primary-glow));
    }

    .nav-menu {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
      transform: translateX(4px);
    }

    .nav-item:active {
      background: rgba(99, 102, 241, 0.2);
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), transparent);
      color: var(--text-main);
      border-left: 3px solid var(--primary);
      border-radius: 4px var(--radius-md) var(--radius-md) 4px;
    }

    .nav-item.active i {
      color: var(--primary);
      filter: drop-shadow(0 0 8px var(--primary-glow));
    }

    .nav-item i {
      font-size: 1.3rem;
      transition: transform 0.3s;
    }

    .nav-item:hover i {
      transform: scale(1.1);
    }

    .sidebar-footer {
      padding-top: 1.5rem;
      border-top: var(--glass-border);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      transition: margin 0.3s ease;
      position: relative;
      min-height: 100vh;
    }

    h2 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.5px;
      color: var(--text-main);
    }

    h2 i {
      color: var(--accent);
      filter: drop-shadow(0 0 10px var(--accent-glow));
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: var(--glass-border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-lg), var(--glow-card);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.6), var(--glow-card);
    }

    /* Date Selector */
    .date-selector {
      display: flex;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 2rem;
      background: rgba(30, 41, 59, 0.4);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      border: var(--glass-border);
      backdrop-filter: blur(10px);
    }

    .date-input-group {
      flex: 1;
    }

    .date-label {
      display: block;
      margin-bottom: 10px;
      color: var(--text-muted);
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input,
    select,
    .date-input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--text-main);
      padding: 14px 18px;
      border-radius: var(--radius-md);
      font-family: var(--font-main);
      font-size: 1rem;
      transition: all 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
    }

    input:focus,
    select:focus,
    .date-input:focus {
      border-color: var(--primary);
      background: rgba(2, 6, 23, 0.8);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    /* Buttons */
    button {
      font-family: var(--font-main);
      border: none;
      cursor: pointer;
      border-radius: var(--radius-md);
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
      transform: translateY(-2px);
    }

    .btn-summary {
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      color: white;
      padding: 14px 28px;
      border-radius: var(--radius-lg);
      font-size: 1.1rem;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
      min-width: 180px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .btn-summary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.6);
    }

    .btn-summary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .btn-danger-light {
      background: rgba(244, 63, 94, 0.1);
      color: var(--danger);
      border: 1px solid rgba(244, 63, 94, 0.2);
    }

    .btn-danger-light:hover {
      background: rgba(244, 63, 94, 0.2);
      border-color: rgba(244, 63, 94, 0.4);
    }

    .btn-warning {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .btn-warning:hover {
      background: rgba(245, 158, 11, 0.25);
    }

    .btn-home {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(8px);
      color: var(--text-main);
      padding: 10px 20px;
      border-radius: 50px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-home:hover {
      background: rgba(40, 50, 70, 0.8);
      transform: translateY(-2px);
    }

    .btn-icon-round {
      width: 38px;
      height: 38px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }

    /* Stats Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .room-card {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s, background 0.2s, border-color 0.2s;
      position: relative;
      overflow: hidden;
    }

    .room-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .room-card:hover {
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .room-card:hover::before {
      opacity: 1;
    }

    .room-card h4 {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 1rem;
    }

    .room-card .val {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 0.8rem;
      line-height: 1;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .room-card .absent-text {
      display: inline-block;
      font-size: 0.85rem;
      color: var(--danger);
      background: rgba(244, 63, 94, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 500;
      border: 1px solid rgba(244, 63, 94, 0.2);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      overflow-y: hidden;
      border-radius: var(--radius-lg);
      border: var(--glass-border);
      background: rgba(15, 23, 42, 0.4);
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th {
      text-align: left;
      padding: 18px 24px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(255, 255, 255, 0.02);
      letter-spacing: 0.5px;
    }

    td {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      color: var(--text-main);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Badges */
    .badge-absent {
      color: var(--danger);
      background: rgba(244, 63, 94, 0.15);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-present {
      color: var(--success);
      background: rgba(16, 185, 129, 0.15);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Login & Overlays */
    #loginPanel {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: #020617;
      background-image:
        radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%),
        radial-gradient(circle at 0% 100%, #312e81 0%, transparent 50%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .page-section {
      display: none;
      animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-spinner {
      padding: 40px;
      text-align: center;
      color: var(--primary);
      font-size: 1.2rem;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .loading-spinner i {
      font-size: 2.5rem;
      animation: spin 1s linear infinite;
    }

    /* Login decoration */
    .login-icon {
      width: 90px;
      height: 90px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      color: var(--primary);
      font-size: 3.5rem;
      border: 2px solid rgba(99, 102, 241, 0.2);
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
      animation: pulseLogin 3s infinite;
    }

    @keyframes pulseLogin {
      0% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
      }

      70% {
        box-shadow: 0 0 0 20px rgba(99, 102, 241, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
      }
    }
  </style>
</head>

<body>
  <!-- Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô -->
  <div class="login-back-button" id="loginBackButton" style="position:fixed; top:20px; right:20px; z-index:2001;">
    <button class="btn-home" onclick="goToMainMenu()">
      <i class="ri-home-line"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
    </button>
  </div>

  <div class="top-bar-buttons" id="loggedInBackButton"
    style="position:fixed; top:20px; right:20px; z-index:150; display:none;">
    <button class="btn-home" onclick="goToMainMenu()">
      <i class="ri-home-line"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
    </button>
  </div>

  <button id="mobileMenuBtn" style="display:none;" onclick="toggleSidebar()">
    <i class="ri-menu-line"></i>
  </button>

  <div id="loadingOverlay">
    <div
      style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
    </div>
    <p style="margin-top: 20px; color: var(--text-main); font-weight: 500;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
  </div>

  <div id="loginPanel">
    <div class="card" style="width: 100%; max-width: 420px; text-align: center; padding: 3rem 2rem;">
      <div class="login-icon">
        <i class="ri-shield-keyhole-line"></i>
      </div>

      <h2 style="justify-content: center; margin-bottom: 10px;">Admin</h2>

      <div style="text-align: left; margin-bottom: 20px;">
        <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
        <input type="email" id="email" placeholder="admin@school.ac.th">
      </div>

      <div style="text-align: left; margin-bottom: 30px;">
        <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <button class="btn-primary" onclick="handleLogin()" style="width:100%; padding: 14px; font-size: 1.1rem;">
        <i class="ri-login-circle-line"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="ri-shield-check-fill"></i> ADMIN
    </div>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="switchTab('dashboard', this)">
        <i class="ri-dashboard-3-line"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
      </div>
      <div class="nav-item" onclick="switchTab('manage', this)">
        <i class="ri-user-settings-line"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
      </div>
      <div class="nav-item" onclick="switchTab('import', this)">
        <i class="ri-folder-upload-line"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV
      </div>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
        <img id="profileImage"
          src="https://media.discordapp.net/attachments/1282030855119966349/1471830866945638430/IMG_8813.png?ex=69905ccf&is=698f0b4f&hm=ca7144419ee277200fdac36b937f86b069b375b33a510f0f64d1ea41c516b08f&=&format=webp&quality=lossless&width=649&height=648"
          style="width:40px; height:40px; border-radius:50%; object-fit:cover; border: 2px solid var(--primary);">
        <span id="displayName" style="font-size:0.9rem; font-weight:500;">Loading...</span>
      </div>
      <button class="btn-danger-light" onclick="handleLogout()"
        style="width:100%; justify-content:center; font-size: 0.9rem; padding: 10px;">
        <i class="ri-logout-circle-r-line"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </aside>

  <main class="main-content">

    <section id="dashboard" class="page-section active">
      <div class="section-header">
        <h2><i class="ri-bar-chart-2-fill"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <button class="btn-success" onclick="exportAbsentList()">
          <i class="ri-file-download-line"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        </button>
      </div>


      <div class="date-selector">
        <div class="date-input-group">
          <label class="date-label"><i class="ri-calendar-event-line"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ</label>
          <input type="date" id="reportDate" class="date-input">
        </div>
        <button class="btn-summary" onclick="generateSummary()" id="summaryButton">
          <i class="ri-file-list-line"></i>
          <span>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</span>
        </button>
      </div>

      <div class="summary-content" id="summaryContent">
        <div class="card">
          <div class="summary-grid" id="roomStatsGrid"></div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                  <th>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="summaryList"></tbody>
            </table>
          </div>
        </div>

        <h3 style="color:var(--danger); display:flex; align-items:center; gap:10px; margin: 3rem 0 1.5rem;">
          <i class="ri-user-unfollow-line"></i> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
        </h3>
        <div class="card" style="padding: 1.5rem;">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th>‡∏´‡πâ‡∏≠‡∏á</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="absentDetailList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="manage" class="page-section">
      <div class="section-header">
        <h2><i class="ri-group-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <button class="btn-primary" onclick="startEdit('', '', '6/1')">
          <i class="ri-user-add-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>

      <div class="card" id="editForm"
        style="border-left: 4px solid var(--warning); display:none; background: rgba(245, 158, 11, 0.05);">
        <h3 style="margin-top:0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
          <i class="ri-edit-box-line"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h3>
        <input type="hidden" id="editOldId">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
          <div>
            <label
              style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
            <input type="number" id="editId" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20456">
          </div>
          <div>
            <label
              style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="editName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
          </div>
          <div>
            <label style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">‡∏´‡πâ‡∏≠‡∏á</label>
            <select id="editClass">
              <option value="6/1">6/1</option>
              <option value="6/2">6/2</option>
              <option value="6/3">6/3</option>
              <option value="6/4">6/4</option>
              <option value="6/5">6/5</option>
              <option value="6/6">6/6</option>
              <option value="6/7">6/7</option>
            </select>
          </div>
        </div>
        <div style="margin-top:30px; display:flex; gap:12px; flex-wrap: wrap;">
          <button class="btn-primary" onclick="updateStudent()" style="flex: 1; min-width: 140px;">
            <i class="ri-save-line"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
          <button class="btn-danger-light" onclick="cancelEdit()" style="flex: 1; min-width: 140px;">
            <i class="ri-close-line"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
        </div>
      </div>

      <div class="card">
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:1.5rem;">
          <div style="position:relative;">
            <i class="ri-search-line"
              style="position:absolute; left:18px; top:50%; transform:translateY(-50%); color:var(--text-muted); z-index: 10;"></i>
            <input type="text" id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." oninput="renderStudentTable()"
              style="padding-left:48px;">
          </div>
          <select id="filterClass" onchange="renderStudentTable()">
            <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            <option value="6/1">‡∏°.6/1</option>
            <option value="6/2">‡∏°.6/2</option>
            <option value="6/3">‡∏°.6/3</option>
            <option value="6/4">‡∏°.6/4</option>
            <option value="6/5">‡∏°.6/5</option>
            <option value="6/6">‡∏°.6/6</option>
            <option value="6/7">‡∏°.6/7</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡∏´‡πâ‡∏≠‡∏á</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="studentTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="import" class="page-section">
      <div class="section-header">
        <h2><i class="ri-database-fill"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
      </div>
      <div class="card" style="text-align:center; padding: 5rem 2rem;">
        <div
          style="width: 120px; height: 120px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem; border: 1px solid rgba(99, 102, 241, 0.2);">
          <i class="ri-file-excel-2-line" style="font-size: 4rem; color: var(--primary);"></i>
        </div>
        <h3 style="margin: 0 0 15px; font-size: 1.8rem;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (.CSV)</h3>
        <p
          style="color:var(--text-muted); margin-bottom:35px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
          ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong>, <strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</strong>, <strong>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong><br>
          <span
            style="color:var(--warning); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; margin-top: 10px;">
            <i class="ri-information-line"></i> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </span>
        </p>
        <div style="max-width: 450px; margin: 0 auto;">
          <input type="file" id="csvFileInput" accept=".csv"
            style="margin-bottom:20px; width:100%; border: 2px dashed rgba(255,255,255,0.1); background: transparent; height: auto; text-align: center; padding: 20px;">
          <button class="btn-primary" onclick="importCSV()"
            style="width:100%; justify-content:center; padding:16px; font-size: 1.1rem;">
            <i class="ri-upload-cloud-fill"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå
          </button>
        </div>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVPuFr9DQKlpG8eeX5Jvr8TmcEH_7i7uM",
      authDomain: "bathroom-check-system.firebaseapp.com",
      projectId: "bathroom-check-system",
      storageBucket: "bathroom-check-system.firebasestorage.app",
      messagingSenderId: "738596491428",
      appId: "1:738596491428:web:756904f5c62ee5fe081631"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allStudents = [];
    let currentAbsentList = [];
    let currentLoggedIds = [];
    let unsubscribeStats = null;

    window.goToMainMenu = function () {
      window.location.href = 'https://bathroom-check-system.web.app/all.html';
    }

    window.toggleSidebar = () => {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('show');
      overlay.classList.toggle('show');
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ scroll ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
      if (sidebar.classList.contains('show')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    };

    window.closeSidebar = () => {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    };

    window.switchTab = (id, el) => {
      document.querySelectorAll('.page-section, .nav-item').forEach(x => x.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
      // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ó‡∏ö‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
      if (window.innerWidth <= 1024) {
        closeSidebar();
      }
    };

    window.showLoading = (show) => document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";

    window.generateSummary = function () {
      const date = document.getElementById('reportDate').value;
      if (!date) {
        Swal.fire({
          icon: 'warning',
          title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
          text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'
        });
        return;
      }

      const content = document.getElementById('summaryContent');

      document.getElementById('roomStatsGrid').innerHTML = `
        <div class="loading-spinner" style="grid-column: 1/-1;">
          <i class="ri-loader-4-line"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
      `;
      document.getElementById('summaryList').innerHTML = '';
      document.getElementById('absentDetailList').innerHTML = '';

      content.classList.add('show');

      loadStats();
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("loggedInBackButton").style.display = "block";
        document.getElementById("loginBackButton").style.display = "none";

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        const profileImage = document.getElementById('profileImage');
        const displayName = document.getElementById('displayName');

        if (user.email === "hdr1234@gmail.com") {
          displayName.innerText = "‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏Å‡∏¥‡∏ï‡∏ï‡πå ‡∏î‡∏∏‡∏©‡∏é‡∏µ‡∏ò‡∏µ‡∏£‡∏ß‡∏á‡∏®‡πå";
          profileImage.src = "https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/PP.JPG";
        } else if (user.email === "berm44@gmail.com") {
          displayName.innerText = "Dev B";
          profileImage.src = "https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/Tee.jpg";
        } else {
          displayName.innerText = "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö";
          profileImage.src = "https://media.discordapp.net/attachments/1282030855119966349/1471830866945638430/IMG_8813.png?ex=69905ccf&is=698f0b4f&hm=ca7144419ee277200fdac36b937f86b069b375b33a510f0f64d1ea41c516b08f&=&format=webp&quality=lossless&width=649&height=648";
        }

        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('reportDate').value = `${year}-${month}-${day}`;

        initData();
      } else {
        document.getElementById("loginPanel").style.display = "flex";
        document.getElementById("loggedInBackButton").style.display = "none";
        document.getElementById("loginBackButton").style.display = "block";
      }
    });

    window.handleLogin = async () => {
      try {
        await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value);
        Swal.fire({ icon: 'success', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', timer: 1500, showConfirmButton: false });
      } catch (e) {
        Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' });
      }
    };

    window.handleLogout = () => signOut(auth);

    function initData() {
      onSnapshot(collection(db, "students"), (snap) => {
        allStudents = [];
        snap.forEach(doc => allStudents.push({ id: doc.id, ...doc.data() }));
        console.log('‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß:', allStudents.length, '‡∏Ñ‡∏ô');
      });
    }

    window.startEdit = (id, name, cls) => {
      document.getElementById("editForm").style.display = "block";
      document.getElementById("editOldId").value = id;
      document.getElementById("editId").value = id;
      document.getElementById("editName").value = name;
      document.getElementById("editClass").value = cls;

      if (!id) document.querySelector('#editForm h3').innerHTML = '<i class="ri-user-add-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà';
      else document.querySelector('#editForm h3').innerHTML = '<i class="ri-edit-box-line"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.cancelEdit = () => {
      document.getElementById("editForm").style.display = "none";
    };

    window.updateStudent = async () => {
      const oldId = document.getElementById("editOldId").value;
      const newId = document.getElementById("editId").value;
      const name = document.getElementById("editName").value;
      const cls = document.getElementById("editClass").value;

      if (!newId || !name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');

      showLoading(true);
      try {
        if (oldId && oldId !== newId) await deleteDoc(doc(db, "students", oldId));
        await setDoc(doc(db, "students", newId), { name, class: cls });
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        cancelEdit();
      } catch (e) {
        Swal.fire('Error', e.message, 'error');
      }
      showLoading(false);
    };

    window.deleteStudent = async (id) => {
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
        text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™ ${id} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#f43f5e'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await deleteDoc(doc(db, "students", id));
          Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }
      });
    };

    window.markPresent = async (sid) => {
      const date = document.getElementById("reportDate").value;
      const student = allStudents.find(s => s.id == sid);

      Swal.fire({
        title: `‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ${student ? student.name : sid}`,
        text: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await setDoc(doc(db, "attendanceLogs", `${sid}_${date}`), {
            studentId: sid, date: date, timestamp: serverTimestamp(), manual: true
          });
          const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
          Toast.fire({ icon: 'success', title: '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
        }
      });
    };

    window.unmark = async (sid) => {
      const date = document.getElementById("reportDate").value;
      const student = allStudents.find(s => s.id == sid);

      Swal.fire({
        title: `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠?`,
        text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á ${student ? student.name : sid} ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡∏≤‡∏î" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö',
        cancelButtonText: '‡πÑ‡∏°‡πà‡∏•‡∏ö',
        confirmButtonColor: '#f43f5e'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await deleteDoc(doc(db, "attendanceLogs", `${sid}_${date}`));
        }
      });
    };

    window.loadStats = () => {
      const date = document.getElementById("reportDate").value;
      if (!date) return;

      if (unsubscribeStats) unsubscribeStats();

      const q = query(collection(db, "attendanceLogs"), where("date", "==", date));
      unsubscribeStats = onSnapshot(q, (snap) => {
        currentLoggedIds = snap.docs.map(d => d.data().studentId);
        renderDashboard(currentLoggedIds);
        renderStudentTable();
      });
    };

    function renderDashboard(loggedIds) {
      const summary = document.getElementById("summaryList");
      const absentTable = document.getElementById("absentDetailList");
      const grid = document.getElementById("roomStatsGrid");

      summary.innerHTML = "";
      absentTable.innerHTML = "";
      grid.innerHTML = "";
      currentAbsentList = [];

      if (allStudents.length === 0) {
        grid.innerHTML = `<div class="loading-spinner" style="grid-column: 1/-1;">
          <i class="ri-loader-4-line"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...
        </div>`;
        return;
      }

      ["6/1", "6/2", "6/3", "6/4", "6/5", "6/6", "6/7"].forEach(cls => {
        const inRoom = allStudents.filter(s => s.class === cls);
        const present = inRoom.filter(s => loggedIds.includes(s.id));
        const absent = inRoom.filter(s => !loggedIds.includes(s.id));

        grid.innerHTML += `<div class="room-card">
          <h4>ROOM ${cls}</h4>
          <div class="val">${present.length}/${inRoom.length}</div>
          <span class="absent-text">‡∏Ç‡∏≤‡∏î ${absent.length} ‡∏Ñ‡∏ô</span>
        </div>`;

        summary.innerHTML += `<tr>
          <td style="font-weight:600; color:var(--primary)">‡∏°.${cls}</td>
          <td>${inRoom.length}</td>
          <td style="color:var(--success); font-weight:600;">${present.length}</td>
          <td><span class="${absent.length > 0 ? 'badge-absent' : 'badge-present'}">${absent.length > 0 ? absent.length + ' ‡∏Ñ‡∏ô' : '‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö'}</span></td>
        </tr>`;

        absent.forEach(std => {
          currentAbsentList.push(std);
          absentTable.innerHTML += `<tr>
            <td style="font-weight:600;">${std.id}</td>
            <td>${std.name}</td>
            <td>‡∏°.${std.class}</td>
            <td style="display:flex; gap:6px; flex-wrap: wrap;">
              <span class="badge-absent" style="white-space: nowrap;">üî¥ ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
              <button onclick="markPresent('${std.id}')" class="btn-success" style="padding:6px 10px; font-size:0.8rem; white-space: nowrap;">
                <i class="ri-check-line"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
              </button>
            </td>
          </tr>`;
        });
      });

      if (absentTable.innerHTML === "") {
        absentTable.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--success);">
          <i class="ri-checkbox-circle-line" style="font-size:3rem; display:block; margin-bottom:15px;"></i>
          <strong style="font-size:1.2rem;">‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</strong>
        </td></tr>`;
      }
    }

    window.renderStudentTable = () => {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const cls = document.getElementById("filterClass").value;
      const tbody = document.getElementById("studentTable");
      tbody.innerHTML = "";

      allStudents.filter(s => (cls === 'all' || s.class === cls) && (s.name.toLowerCase().includes(search) || s.id.includes(search)))
        .sort((a, b) => a.id - b.id).forEach(s => {
          const isPresent = currentLoggedIds.includes(s.id);
          const statusBtn = isPresent
            ? `<button class="btn-danger-light btn-icon-round" onclick="unmark('${s.id}')" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠"><i class="ri-close-line"></i></button>`
            : `<button class="btn-primary btn-icon-round" style="background:var(--success)" onclick="markPresent('${s.id}')" title="‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠"><i class="ri-check-double-line"></i></button>`;

          tbody.innerHTML += `<tr>
            <td style="font-weight:600;">${s.id}</td>
            <td>${s.name}</td>
            <td><span class="badge-present" style="background:rgba(99, 102, 241, 0.15); color:var(--primary); border: 1px solid rgba(99, 102, 241, 0.3);">‡∏°.${s.class}</span></td>
            <td style="display:flex; gap:6px; flex-wrap: wrap;">
              <button class="btn-warning btn-icon-round" onclick="startEdit('${s.id}','${s.name}','${s.class}')"><i class="ri-edit-line"></i></button>
              ${statusBtn}
              <button class="btn-danger-light btn-icon-round" onclick="deleteStudent('${s.id}')"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>`;
        });
    };

    window.exportAbsentList = () => {
      if (currentAbsentList.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'info');
      let csv = "\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á\n" + currentAbsentList.map(s => `${s.id},${s.name},${s.class}`).join("\n");
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      link.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î_${document.getElementById("reportDate").value}.csv`;
      link.click();
    };

    window.importCSV = () => {
      const fileInput = document.getElementById('csvFileInput');
      if (!fileInput.files[0]) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'warning');

      showLoading(true);
      Papa.parse(fileInput.files[0], {
        complete: async (res) => {
          const data = res.data;
          const CHUNK_SIZE = 450;
          let count = 0;

          try {
            for (let i = 0; i < data.length; i += CHUNK_SIZE) {
              const batch = writeBatch(db);
              const chunk = data.slice(i, i + CHUNK_SIZE);
              chunk.forEach(row => {
                if (row[0] && row[1]) {
                  batch.set(doc(db, "students", row[0].toString().trim()), {
                    name: row[1].trim(),
                    class: (row[2] || "6/1").trim()
                  });
                  count++;
                }
              });
              await batch.commit();
            }
            showLoading(false);
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
          } catch (e) {
            showLoading(false);
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.message, 'error');
          }
        }
      });
    };

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    window.addEventListener('resize', function() {
      if (window.innerWidth > 1024) {
        closeSidebar();
        document.body.style.overflow = '';
      }
    });

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà sidebar ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
    document.querySelector('.sidebar').addEventListener('touchmove', function(e) {
      e.stopPropagation();
    }, { passive: true });

    // Initial State
    document.querySelector('.sidebar').classList.remove('show');
  </script>
</body>

</html>