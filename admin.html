<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>HDR - Admin</title>

  <!-- Favicon - รองรับทุกอุปกรณ์ -->
  <link rel="icon" type="image/x-icon"
    href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">
  <link rel="shortcut icon" href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">
  <link rel="apple-touch-icon"
    href="https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/logo.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

  <style>
    :root {
      --sidebar-width: 280px;
      --font-main: 'Kanit', sans-serif;

      /* New Premium Palette (Deep Space & Nebula) */
      --bg-body: #0f0f1e;
      /* Darker background */
      --bg-sidebar: rgba(15, 15, 35, 0.98);
      /* Darker sidebar */
      --bg-card: rgba(25, 35, 65, 0.7);
      /* Better contrast */
      --bg-input: rgba(5, 10, 30, 0.6);

      --primary: #6366f1;
      /* Indigo 500 */
      --primary-dark: #4f46e5;
      /* Indigo 600 */
      --primary-glow: rgba(99, 102, 241, 0.6);

      --accent: #06b6d4;
      /* Cyan 500 */
      --accent-glow: rgba(6, 182, 212, 0.6);

      --accent-2: #8b5cf6;
      /* Purple 500 */
      --accent-3: #ec4899;
      /* Pink 500 */

      --success: #10b981;
      /* Emerald 500 */
      --danger: #f43f5e;
      /* Rose 500 */
      --warning: #f59e0b;
      /* Amber 500 */

      --text-main: #f8fafc;
      /* Slate 50 */
      --text-muted: #94a3b8;
      /* Slate 400 */

      --border-color: rgba(148, 163, 184, 0.15);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);

      --radius-xl: 24px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;

      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.4);
      --glow-card: 0 0 0 1px rgba(255, 255, 255, 0.08), 0 8px 32px rgba(99, 102, 241, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      outline: none;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      display: flex;
      position: relative;
    }

    /* Ambient Background Effect - Cleaner & "Cool" */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.08) 0%, transparent 60%);
      z-index: -1;
      pointer-events: none;
      animation: bgShift 15s ease-in-out infinite;
    }

    @keyframes bgShift {
      0%, 100% {
        opacity: 1;
      }

      50% {
        opacity: 0.8;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.4);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: var(--glass-border);
      display: flex;
      flex-direction: column;
      padding: 2rem 1.5rem;
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 5px 0 30px rgba(0, 0, 0, 0.2);
    }

    /* ปรับปรุงการแสดงผลบนมือถือและ iPad */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        box-shadow: none;
      }

      .sidebar.show {
        transform: translateX(0);
        box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
      }

      .main-content {
        margin-left: 0 !important;
        padding: 5rem 1rem !important;
        width: 100%;
      }

      /* ปรับปรุงปุ่มเมนูสำหรับมือถือ */
      #mobileMenuBtn {
        display: flex !important;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: var(--bg-card);
        border: var(--glass-border);
        color: var(--text-main);
        width: 48px;
        height: 48px;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        font-size: 1.5rem;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.2s;
      }

      #mobileMenuBtn:active {
        transform: scale(0.95);
        background: rgba(99, 102, 241, 0.2);
      }

      /* ปรับปรุงปุ่มกลับเมนูหลัก */
      #loggedInBackButton {
        top: 15px !important;
        right: 15px !important;
        z-index: 1001 !important;
      }

      #loggedInBackButton button {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 8px 16px;
        font-size: 0.9rem;
      }

      /* ปรับปรุงการ์ดและตาราง */
      .card {
        padding: 1.25rem !important;
        margin-bottom: 1.25rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
        gap: 0.75rem !important;
      }

      .room-card {
        padding: 1rem !important;
      }

      .room-card .val {
        font-size: 1.8rem !important;
      }

      /* ปรับปรุงตารางให้เลื่อนดูได้ */
      .table-container {
        border-radius: var(--radius-md);
        margin: 0 -0.25rem;
        width: calc(100% + 0.5rem);
      }

      table {
        min-width: 600px;
      }

      th, td {
        padding: 12px 16px !important;
        font-size: 0.9rem;
      }

      /* ปรับปรุงปุ่มในตาราง */
      td .btn-icon-round {
        width: 34px;
        height: 34px;
        font-size: 0.9rem;
      }

      td {
        flex-wrap: wrap;
        gap: 6px !important;
      }

      /* ปรับปรุงฟอร์มแก้ไข */
      #editForm {
        padding: 1.25rem !important;
      }

      #editForm > div:first-of-type {
        grid-template-columns: 1fr !important;
      }

      /* ปรับปรุง date selector */
      .date-selector {
        padding: 1rem !important;
        gap: 15px !important;
      }

      .date-input-group {
        width: 100%;
      }

      .btn-summary {
        width: 100%;
        padding: 14px !important;
      }

      /* ปรับปรุง search box */
      #manage .card > div:first-of-type {
        grid-template-columns: 1fr !important;
      }

      /* ปรับปรุง login panel */
      #loginPanel .card {
        padding: 2rem 1.5rem !important;
        max-width: 90% !important;
      }

      .login-back-button button {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
    }

    /* ปรับปรุงเพิ่มเติมสำหรับ iPad ในแนวนอน */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .main-content {
        padding: 5rem 2rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(4, 1fr) !important;
      }
    }

    /* ปรับปรุงสำหรับมือถือขนาดเล็ก */
    @media (max-width: 480px) {
      .main-content {
        padding: 5rem 0.75rem !important;
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .section-header button {
        width: 100%;
      }

      h2 {
        font-size: 1.5rem !important;
      }

      .card {
        padding: 1rem !important;
      }

      .btn-summary {
        font-size: 1rem !important;
      }

      td {
        font-size: 0.85rem !important;
        padding: 10px 12px !important;
      }

      td .btn-icon-round {
        width: 30px;
        height: 30px;
      }

      .badge-absent, .badge-present {
        padding: 4px 10px !important;
        font-size: 0.75rem !important;
      }
    }

    /* คลุมพื้นหลังเมื่อเปิดเมนูบนมือถือ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Desktop Styles */
    @media (min-width: 1025px) {
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 3rem;
      }

      #mobileMenuBtn {
        display: none !important;
      }

      .sidebar-overlay {
        display: none !important;
      }
    }

    .sidebar-header {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 3.5rem;
      padding-left: 0.5rem;
      letter-spacing: 1px;
      background: linear-gradient(135deg, var(--text-main), var(--text-muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar-header i {
      font-size: 2rem;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 12px rgba(99, 102, 241, 0.4));
      -webkit-text-fill-color: var(--primary);
    }

    .nav-menu {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      padding: 16px 18px;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .nav-item:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--text-main);
      transform: translateX(6px);
    }

    .nav-item:active {
      background: rgba(99, 102, 241, 0.2);
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.2), transparent);
      color: var(--primary);
      border-left: 3px solid var(--primary);
      border-radius: 4px var(--radius-md) var(--radius-md) 4px;
    }

    .nav-item.active::before {
      opacity: 1;
    }

    .nav-item.active i {
      color: var(--primary);
      filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.5));
    }

    .nav-item i {
      font-size: 1.4rem;
      transition: transform 0.3s;
    }

    .nav-item:hover i {
      transform: scale(1.15);
    }

    .sidebar-footer {
      padding-top: 1.5rem;
      border-top: var(--glass-border);
      margin-top: auto;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      transition: margin 0.3s ease;
      position: relative;
      min-height: 100vh;
    }

    h2 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 14px;
      letter-spacing: -0.5px;
      color: var(--text-main);
      background: linear-gradient(135deg, var(--text-main), var(--text-muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h2 i {
      color: var(--accent);
      filter: drop-shadow(0 0 12px rgba(6, 182, 212, 0.4));
      -webkit-text-fill-color: var(--accent);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    /* Cards */
    .card {
      background: linear-gradient(135deg, rgba(25, 35, 65, 0.5), rgba(35, 45, 75, 0.3));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: var(--glass-border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-lg), var(--glow-card);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 30px 40px -8px rgba(99, 102, 241, 0.25), var(--glow-card);
    }

    /* Date Selector */
    .date-selector {
      display: flex;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 2rem;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(6, 182, 212, 0.05));
      padding: 2rem;
      border-radius: var(--radius-lg);
      border: var(--glass-border);
      backdrop-filter: blur(10px);
    }

    .date-input-group {
      flex: 1;
    }

    .date-label {
      display: block;
      margin-bottom: 12px;
      color: var(--primary);
      font-size: 0.95rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input,
    select,
    .date-input {
      width: 100%;
      background: linear-gradient(135deg, rgba(5, 10, 30, 0.7), rgba(10, 20, 40, 0.5));
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: var(--text-main);
      padding: 14px 18px;
      border-radius: var(--radius-md);
      font-family: var(--font-main);
      font-size: 1rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-appearance: none;
      appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      padding-right: 48px;
    }

    input:focus,
    select:focus,
    .date-input:focus {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.1));
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2), inset 0 0 0 1px rgba(99, 102, 241, 0.3);
      outline: none;
    }

    /* Buttons */
    button {
      font-family: var(--font-main);
      border: none;
      cursor: pointer;
      border-radius: var(--radius-md);
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::before {
      width: 300px;
      height: 300px;
    }

    button:active {
      transform: scale(0.95);
    }

    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
      position: relative;
    }

    .btn-primary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      border-radius: var(--radius-md);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .btn-primary:hover {
      box-shadow: 0 12px 30px rgba(99, 102, 241, 0.6);
      transform: translateY(-3px);
    }

    .btn-primary:hover::after {
      opacity: 1;
    }

    .btn-summary {
      background: linear-gradient(135deg, var(--primary), var(--accent-2));
      color: white;
      padding: 14px 32px;
      border-radius: var(--radius-lg);
      font-size: 1.1rem;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.45);
      min-width: 180px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      position: relative;
    }

    .btn-summary::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), transparent);
      border-radius: var(--radius-lg);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .btn-summary:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(139, 92, 246, 0.6);
    }

    .btn-summary:hover::after {
      opacity: 1;
    }

    .btn-summary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      position: relative;
    }

    .btn-success::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      border-radius: var(--radius-md);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.6);
    }

    .btn-success:hover::after {
      opacity: 1;
    }

    .btn-danger-light {
      background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.08));
      color: var(--danger);
      border: 1.5px solid rgba(244, 63, 94, 0.3);
      font-weight: 600;
    }

    .btn-danger-light:hover {
      background: linear-gradient(135deg, rgba(244, 63, 94, 0.25), rgba(244, 63, 94, 0.15));
      border-color: rgba(244, 63, 94, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(244, 63, 94, 0.2);
    }

    .btn-warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
      color: #fbbf24;
      border: 1.5px solid rgba(245, 158, 11, 0.4);
      font-weight: 600;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.2));
      border-color: rgba(245, 158, 11, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(245, 158, 11, 0.2);
    }

    .btn-home {
      background: linear-gradient(135deg, rgba(40, 50, 80, 0.8), rgba(30, 40, 65, 0.6));
      backdrop-filter: blur(10px);
      color: var(--text-main);
      padding: 12px 24px;
      border-radius: 50px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      font-size: 0.95rem;
      font-weight: 600;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .btn-home:hover {
      background: linear-gradient(135deg, rgba(50, 60, 100, 0.9), rgba(40, 50, 80, 0.7));
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
    }

    .btn-icon-round {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: var(--primary);
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-icon-round:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.35), rgba(99, 102, 241, 0.2));
      border-color: rgba(99, 102, 241, 0.5);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
    }

    /* Stats Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.8rem;
      margin-bottom: 2.5rem;
    }

    .room-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(6, 182, 212, 0.08));
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .room-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .room-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .room-card:hover {
      transform: translateY(-6px);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(6, 182, 212, 0.12));
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 12px 30px rgba(99, 102, 241, 0.2);
    }

    .room-card:hover::after {
      opacity: 1;
    }

    .room-card h4 {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 1rem;
    }

    .room-card .val {
      font-size: 2.8rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 0.8rem;
      line-height: 1;
      text-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .room-card .absent-text {
      display: inline-block;
      font-size: 0.85rem;
      color: var(--danger);
      background: rgba(244, 63, 94, 0.15);
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      border: 1px solid rgba(244, 63, 94, 0.3);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      overflow-y: hidden;
      border-radius: var(--radius-lg);
      border: var(--glass-border);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(25, 35, 65, 0.3));
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th {
      text-align: left;
      padding: 18px 24px;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--primary);
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
      background: rgba(99, 102, 241, 0.05);
      letter-spacing: 1px;
    }

    td {
      padding: 18px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      color: var(--text-main);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover td {
      background: rgba(99, 102, 241, 0.08);
    }

    /* Badges */
    .badge-absent {
      color: var(--danger);
      background: linear-gradient(135deg, rgba(244, 63, 94, 0.2), rgba(244, 63, 94, 0.1));
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1.5px solid rgba(244, 63, 94, 0.4);
      box-shadow: 0 4px 12px rgba(244, 63, 94, 0.15);
    }

    .badge-present {
      color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1.5px solid rgba(16, 185, 129, 0.4);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }

    /* Login & Overlays */
    #loginPanel {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: #020617;
      background-image:
        radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%),
        radial-gradient(circle at 0% 100%, #312e81 0%, transparent 50%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .page-section {
      display: none;
      animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-spinner {
      padding: 40px;
      text-align: center;
      color: var(--primary);
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .loading-spinner i {
      font-size: 3rem;
      animation: spin 1.5s linear infinite;
    }

    /* Login decoration */
    .login-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.1));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      color: var(--primary);
      font-size: 4rem;
      border: 2.5px solid rgba(99, 102, 241, 0.4);
      box-shadow: 0 0 40px rgba(99, 102, 241, 0.3), inset 0 0 30px rgba(6, 182, 212, 0.1);
      animation: pulseLogin 3.5s ease-in-out infinite;
    }

    @keyframes pulseLogin {
      0% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.5), inset 0 0 30px rgba(6, 182, 212, 0.1);
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      70% {
        box-shadow: 0 0 0 25px rgba(99, 102, 241, 0), inset 0 0 30px rgba(6, 182, 212, 0.1);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0), inset 0 0 30px rgba(6, 182, 212, 0.1);
        transform: scale(1);
      }
    }
  </style>
</head>

<body>
  <!-- Overlay สำหรับปิดเมนูเมื่อคลิกด้านนอก -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- ปุ่มกลับเมนูหลักสำหรับหน้าล็อคอิน -->
  <div class="login-back-button" id="loginBackButton" style="position:fixed; top:20px; right:20px; z-index:2001;">
    <button class="btn-home" onclick="goToMainMenu()">
      <i class="ri-home-line"></i> กลับเมนูหลัก
    </button>
  </div>

  <div class="top-bar-buttons" id="loggedInBackButton"
    style="position:fixed; top:20px; right:20px; z-index:150; display:none;">
    <button class="btn-home" onclick="goToMainMenu()">
      <i class="ri-home-line"></i> กลับเมนูหลัก
    </button>
  </div>

  <button id="mobileMenuBtn" style="display:none;" onclick="toggleSidebar()">
    <i class="ri-menu-line"></i>
  </button>

  <div id="loadingOverlay">
    <div
      style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
    </div>
    <p style="margin-top: 20px; color: var(--text-main); font-weight: 500;">กำลังประมวลผล...</p>
  </div>

  <div id="loginPanel">
    <div class="card" style="width: 100%; max-width: 420px; text-align: center; padding: 3rem 2rem;">
      <div class="login-icon">
        <i class="ri-shield-keyhole-line"></i>
      </div>

      <h2 style="justify-content: center; margin-bottom: 10px;">Admin</h2>

      <div style="text-align: left; margin-bottom: 20px;">
        <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">อีเมลผู้ดูแล</label>
        <input type="email" id="email" placeholder="admin@school.ac.th">
      </div>

      <div style="text-align: left; margin-bottom: 30px;">
        <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">รหัสผ่าน</label>
        <input type="password" id="password" placeholder="••••••••">
      </div>

      <button class="btn-primary" onclick="handleLogin()" style="width:100%; padding: 14px; font-size: 1.1rem;">
        <i class="ri-login-circle-line"></i> เข้าสู่ระบบ
      </button>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <i class="ri-shield-check-fill"></i> ADMIN
    </div>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="switchTab('dashboard', this)">
        <i class="ri-dashboard-3-line"></i> สรุปรายชื่อเข้าเรียน
      </div>
      <div class="nav-item" onclick="switchTab('manage', this)">
        <i class="ri-user-settings-line"></i> จัดการรายชื่อ
      </div>
      <div class="nav-item" onclick="switchTab('import', this)">
        <i class="ri-folder-upload-line"></i> นำเข้าข้อมูล CSV
      </div>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
        <img id="profileImage"
          src="https://media.discordapp.net/attachments/1282030855119966349/1471830866945638430/IMG_8813.png?ex=69905ccf&is=698f0b4f&hm=ca7144419ee277200fdac36b937f86b069b375b33a510f0f64d1ea41c516b08f&=&format=webp&quality=lossless&width=649&height=648"
          style="width:40px; height:40px; border-radius:50%; object-fit:cover; border: 2px solid var(--primary);">
        <span id="displayName" style="font-size:0.9rem; font-weight:500;">Loading...</span>
      </div>
      <button class="btn-danger-light" onclick="handleLogout()"
        style="width:100%; justify-content:center; font-size: 0.9rem; padding: 10px;">
        <i class="ri-logout-circle-r-line"></i> ออกจากระบบ
      </button>
    </div>
  </aside>

  <main class="main-content">

    <section id="dashboard" class="page-section active">
      <div class="section-header">
        <h2><i class="ri-bar-chart-2-fill"></i> สรุปรายชื่อเข้าเรียน</h2>
        <button class="btn-success" onclick="exportAbsentList()">
          <i class="ri-file-download-line"></i> ส่งออกรายงาน
        </button>
      </div>


      <div class="date-selector">
        <div class="date-input-group">
          <label class="date-label"><i class="ri-calendar-event-line"></i> เลือกวันที่ต้องการสรุป</label>
          <input type="date" id="reportDate" class="date-input">
        </div>
        <button class="btn-summary" onclick="generateSummary()" id="summaryButton">
          <i class="ri-file-list-line"></i>
          <span>สรุปรายชื่อ</span>
        </button>
      </div>

      <div class="summary-content" id="summaryContent">
        <div class="card">
          <div class="summary-grid" id="roomStatsGrid"></div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>ห้องเรียน</th>
                  <th>จำนวนทั้งหมด</th>
                  <th>เช็คชื่อแล้ว</th>
                  <th>สถานะ</th>
                </tr>
              </thead>
              <tbody id="summaryList"></tbody>
            </table>
          </div>
        </div>

        <h3 style="color:var(--danger); display:flex; align-items:center; gap:10px; margin: 3rem 0 1.5rem;">
          <i class="ri-user-unfollow-line"></i> นักเรียนที่ยังไม่เช็คชื่อ
        </h3>
        <div class="card" style="padding: 1.5rem;">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>รหัสประจำตัว</th>
                  <th>ชื่อ-นามสกุล</th>
                  <th>ห้อง</th>
                  <th>จัดการสถานะ</th>
                </tr>
              </thead>
              <tbody id="absentDetailList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="manage" class="page-section">
      <div class="section-header">
        <h2><i class="ri-group-fill"></i> จัดการรายชื่อนักเรียน</h2>
        <button class="btn-primary" onclick="startEdit('', '', '6/1')">
          <i class="ri-user-add-line"></i> เพิ่มนักเรียนใหม่
        </button>
      </div>

      <div class="card" id="editForm"
        style="border-left: 4px solid var(--warning); display:none; background: rgba(245, 158, 11, 0.05);">
        <h3 style="margin-top:0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
          <i class="ri-edit-box-line"></i> ข้อมูลนักเรียน
        </h3>
        <input type="hidden" id="editOldId">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
          <div>
            <label
              style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">รหัสประจำตัว</label>
            <input type="number" id="editId" placeholder="เช่น 20456">
          </div>
          <div>
            <label
              style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">ชื่อ-นามสกุล</label>
            <input type="text" id="editName" placeholder="เช่น นายสมชาย ใจดี">
          </div>
          <div>
            <label style="display:block; margin-bottom:8px; font-size:0.9rem; color: var(--text-muted);">ห้อง</label>
            <select id="editClass">
              <option value="6/1">6/1</option>
              <option value="6/2">6/2</option>
              <option value="6/3">6/3</option>
              <option value="6/4">6/4</option>
              <option value="6/5">6/5</option>
              <option value="6/6">6/6</option>
              <option value="6/7">6/7</option>
            </select>
          </div>
        </div>
        <div style="margin-top:30px; display:flex; gap:12px; flex-wrap: wrap;">
          <button class="btn-primary" onclick="updateStudent()" style="flex: 1; min-width: 140px;">
            <i class="ri-save-line"></i> บันทึกข้อมูล
          </button>
          <button class="btn-danger-light" onclick="cancelEdit()" style="flex: 1; min-width: 140px;">
            <i class="ri-close-line"></i> ยกเลิก
          </button>
        </div>
      </div>

      <div class="card">
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:1.5rem;">
          <div style="position:relative;">
            <i class="ri-search-line"
              style="position:absolute; left:18px; top:50%; transform:translateY(-50%); color:var(--text-muted); z-index: 10;"></i>
            <input type="text" id="searchBox" placeholder="ค้นหารายชื่อนักเรียน..." oninput="renderStudentTable()"
              style="padding-left:48px;">
          </div>
          <select id="filterClass" onchange="renderStudentTable()">
            <option value="all">แสดงทุกห้อง</option>
            <option value="6/1">ม.6/1</option>
            <option value="6/2">ม.6/2</option>
            <option value="6/3">ม.6/3</option>
            <option value="6/4">ม.6/4</option>
            <option value="6/5">ม.6/5</option>
            <option value="6/6">ม.6/6</option>
            <option value="6/7">ม.6/7</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>รหัส</th>
                <th>ชื่อ-นามสกุล</th>
                <th>ห้อง</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="studentTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="import" class="page-section">
      <div class="section-header">
        <h2><i class="ri-database-fill"></i> นำเข้าข้อมูลระบบ</h2>
      </div>
      <div class="card" style="text-align:center; padding: 5rem 2rem;">
        <div
          style="width: 120px; height: 120px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem; border: 1px solid rgba(99, 102, 241, 0.2);">
          <i class="ri-file-excel-2-line" style="font-size: 4rem; color: var(--primary);"></i>
        </div>
        <h3 style="margin: 0 0 15px; font-size: 1.8rem;">อัปโหลดไฟล์นักเรียน (.CSV)</h3>
        <p
          style="color:var(--text-muted); margin-bottom:35px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
          ไฟล์ควรมีคอลัมน์: <strong>รหัสนักเรียน</strong>, <strong>ชื่อ-นามสกุล</strong>, <strong>ห้องเรียน</strong><br>
          <span
            style="color:var(--warning); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; margin-top: 10px;">
            <i class="ri-information-line"></i> รองรับไฟล์ขนาดใหญ่ ระบบจะแบ่งนำเข้าอัตโนมัติ
          </span>
        </p>
        <div style="max-width: 450px; margin: 0 auto;">
          <input type="file" id="csvFileInput" accept=".csv"
            style="margin-bottom:20px; width:100%; border: 2px dashed rgba(255,255,255,0.1); background: transparent; height: auto; text-align: center; padding: 20px;">
          <button class="btn-primary" onclick="importCSV()"
            style="width:100%; justify-content:center; padding:16px; font-size: 1.1rem;">
            <i class="ri-upload-cloud-fill"></i> เริ่มประมวลผลไฟล์
          </button>
        </div>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVPuFr9DQKlpG8eeX5Jvr8TmcEH_7i7uM",
      authDomain: "bathroom-check-system.firebaseapp.com",
      projectId: "bathroom-check-system",
      storageBucket: "bathroom-check-system.firebasestorage.app",
      messagingSenderId: "738596491428",
      appId: "1:738596491428:web:756904f5c62ee5fe081631"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allStudents = [];
    let currentAbsentList = [];
    let currentLoggedIds = [];
    let unsubscribeStats = null;

    window.goToMainMenu = function () {
      window.location.href = 'https://bathroom-check-system.web.app/all.html';
    }

    window.toggleSidebar = () => {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('show');
      overlay.classList.toggle('show');
      
      // ป้องกันการ scroll เมื่อเปิดเมนู
      if (sidebar.classList.contains('show')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    };

    window.closeSidebar = () => {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    };

    window.switchTab = (id, el) => {
      document.querySelectorAll('.page-section, .nav-item').forEach(x => x.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
      // ปิดเมนูอัตโนมัติเมื่อเปลี่ยนแทบบนมือถือ
      if (window.innerWidth <= 1024) {
        closeSidebar();
      }
    };

    window.showLoading = (show) => document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";

    window.generateSummary = function () {
      const date = document.getElementById('reportDate').value;
      if (!date) {
        Swal.fire({
          icon: 'warning',
          title: 'กรุณาเลือกวันที่',
          text: 'เลือกวันที่ที่ต้องการดูสรุปรายชื่อก่อนครับ'
        });
        return;
      }

      const content = document.getElementById('summaryContent');

      document.getElementById('roomStatsGrid').innerHTML = `
        <div class="loading-spinner" style="grid-column: 1/-1;">
          <i class="ri-loader-4-line"></i> กำลังโหลดข้อมูล...
        </div>
      `;
      document.getElementById('summaryList').innerHTML = '';
      document.getElementById('absentDetailList').innerHTML = '';

      content.classList.add('show');

      loadStats();
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("loggedInBackButton").style.display = "block";
        document.getElementById("loginBackButton").style.display = "none";

        // กำหนดชื่อและรูปตามอีเมล
        const profileImage = document.getElementById('profileImage');
        const displayName = document.getElementById('displayName');

        if (user.email === "hdr1234@gmail.com") {
          displayName.innerText = "ครูประกิตต์ ดุษฎีธีรวงศ์";
          profileImage.src = "https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/PP.JPG";
        } else if (user.email === "berm44@gmail.com") {
          displayName.innerText = "Dev B";
          profileImage.src = "https://gfvrvhlchpdjwlbeszfw.supabase.co/storage/v1/object/public/avatars/Tee.jpg";
        } else {
          displayName.innerText = "ผู้ดูแลระบบ";
          profileImage.src = "https://media.discordapp.net/attachments/1282030855119966349/1471830866945638430/IMG_8813.png?ex=69905ccf&is=698f0b4f&hm=ca7144419ee277200fdac36b937f86b069b375b33a510f0f64d1ea41c516b08f&=&format=webp&quality=lossless&width=649&height=648";
        }

        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('reportDate').value = `${year}-${month}-${day}`;

        initData();
      } else {
        document.getElementById("loginPanel").style.display = "flex";
        document.getElementById("loggedInBackButton").style.display = "none";
        document.getElementById("loginBackButton").style.display = "block";
      }
    });

    window.handleLogin = async () => {
      try {
        await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value);
        Swal.fire({ icon: 'success', title: 'welcome', timer: 1500, showConfirmButton: false });
      } catch (e) {
        Swal.fire({ icon: 'error', title: 'ผิดพลาด', text: 'ข้อมูลล็อกอินไม่ถูกต้อง' });
      }
    };

    window.handleLogout = () => signOut(auth);

    function initData() {
      onSnapshot(collection(db, "students"), (snap) => {
        allStudents = [];
        snap.forEach(doc => allStudents.push({ id: doc.id, ...doc.data() }));
        console.log('โหลดนักเรียนแล้ว:', allStudents.length, 'คน');
      });
    }

    window.startEdit = (id, name, cls) => {
      document.getElementById("editForm").style.display = "block";
      document.getElementById("editOldId").value = id;
      document.getElementById("editId").value = id;
      document.getElementById("editName").value = name;
      document.getElementById("editClass").value = cls;

      if (!id) document.querySelector('#editForm h3').innerHTML = '<i class="ri-user-add-line"></i> เพิ่มนักเรียนใหม่';
      else document.querySelector('#editForm h3').innerHTML = '<i class="ri-edit-box-line"></i> แก้ไขข้อมูลนักเรียน';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.cancelEdit = () => {
      document.getElementById("editForm").style.display = "none";
    };

    window.updateStudent = async () => {
      const oldId = document.getElementById("editOldId").value;
      const newId = document.getElementById("editId").value;
      const name = document.getElementById("editName").value;
      const cls = document.getElementById("editClass").value;

      if (!newId || !name) return Swal.fire('แจ้งเตือน', 'กรุณากรอกข้อมูลให้ครบ', 'warning');

      showLoading(true);
      try {
        if (oldId && oldId !== newId) await deleteDoc(doc(db, "students", oldId));
        await setDoc(doc(db, "students", newId), { name, class: cls });
        Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
        cancelEdit();
      } catch (e) {
        Swal.fire('Error', e.message, 'error');
      }
      showLoading(false);
    };

    window.deleteStudent = async (id) => {
      Swal.fire({
        title: 'ยืนยันการลบ?',
        text: `ต้องการลบข้อมูลรหัส ${id} หรือไม่?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ลบข้อมูล',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#f43f5e'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await deleteDoc(doc(db, "students", id));
          Swal.fire('ลบแล้ว', 'ข้อมูลถูกลบเรียบร้อย', 'success');
        }
      });
    };

    window.markPresent = async (sid) => {
      const date = document.getElementById("reportDate").value;
      const student = allStudents.find(s => s.id == sid);

      Swal.fire({
        title: `เช็คชื่อ ${student ? student.name : sid}`,
        text: `ยืนยันการเช็คชื่อสำหรับวันที่ ${date}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await setDoc(doc(db, "attendanceLogs", `${sid}_${date}`), {
            studentId: sid, date: date, timestamp: serverTimestamp(), manual: true
          });
          const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
          Toast.fire({ icon: 'success', title: 'เช็คชื่อเรียบร้อย' });
        }
      });
    };

    window.unmark = async (sid) => {
      const date = document.getElementById("reportDate").value;
      const student = allStudents.find(s => s.id == sid);

      Swal.fire({
        title: `ยกเลิกการเช็คชื่อ?`,
        text: `ต้องการดึง ${student ? student.name : sid} กลับเป็น "ขาด" ใช่หรือไม่?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ยืนยันลบ',
        cancelButtonText: 'ไม่ลบ',
        confirmButtonColor: '#f43f5e'
      }).then(async (result) => {
        if (result.isConfirmed) {
          await deleteDoc(doc(db, "attendanceLogs", `${sid}_${date}`));
        }
      });
    };

    window.loadStats = () => {
      const date = document.getElementById("reportDate").value;
      if (!date) return;

      if (unsubscribeStats) unsubscribeStats();

      const q = query(collection(db, "attendanceLogs"), where("date", "==", date));
      unsubscribeStats = onSnapshot(q, (snap) => {
        currentLoggedIds = snap.docs.map(d => d.data().studentId);
        renderDashboard(currentLoggedIds);
        renderStudentTable();
      });
    };

    function renderDashboard(loggedIds) {
      const summary = document.getElementById("summaryList");
      const absentTable = document.getElementById("absentDetailList");
      const grid = document.getElementById("roomStatsGrid");

      summary.innerHTML = "";
      absentTable.innerHTML = "";
      grid.innerHTML = "";
      currentAbsentList = [];

      if (allStudents.length === 0) {
        grid.innerHTML = `<div class="loading-spinner" style="grid-column: 1/-1;">
          <i class="ri-loader-4-line"></i> กำลังโหลดข้อมูลนักเรียน...
        </div>`;
        return;
      }

      ["6/1", "6/2", "6/3", "6/4", "6/5", "6/6", "6/7"].forEach(cls => {
        const inRoom = allStudents.filter(s => s.class === cls);
        const present = inRoom.filter(s => loggedIds.includes(s.id));
        const absent = inRoom.filter(s => !loggedIds.includes(s.id));

        grid.innerHTML += `<div class="room-card">
          <h4>ROOM ${cls}</h4>
          <div class="val">${present.length}/${inRoom.length}</div>
          <span class="absent-text">ขาด ${absent.length} คน</span>
        </div>`;

        summary.innerHTML += `<tr>
          <td style="font-weight:600; color:var(--primary)">ม.${cls}</td>
          <td>${inRoom.length}</td>
          <td style="color:var(--success); font-weight:600;">${present.length}</td>
          <td><span class="${absent.length > 0 ? 'badge-absent' : 'badge-present'}">${absent.length > 0 ? absent.length + ' คน' : 'มาครบ'}</span></td>
        </tr>`;

        absent.forEach(std => {
          currentAbsentList.push(std);
          absentTable.innerHTML += `<tr>
            <td style="font-weight:600;">${std.id}</td>
            <td>${std.name}</td>
            <td>ม.${std.class}</td>
            <td style="display:flex; gap:6px; flex-wrap: wrap;">
              <span class="badge-absent" style="white-space: nowrap;">🔴 ขาดเรียน</span>
              <button onclick="markPresent('${std.id}')" class="btn-success" style="padding:6px 10px; font-size:0.8rem; white-space: nowrap;">
                <i class="ri-check-line"></i> เช็คชื่อ
              </button>
            </td>
          </tr>`;
        });
      });

      if (absentTable.innerHTML === "") {
        absentTable.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--success);">
          <i class="ri-checkbox-circle-line" style="font-size:3rem; display:block; margin-bottom:15px;"></i>
          <strong style="font-size:1.2rem;">มาครบทุกคนแล้ว!</strong>
        </td></tr>`;
      }
    }

    window.renderStudentTable = () => {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const cls = document.getElementById("filterClass").value;
      const tbody = document.getElementById("studentTable");
      tbody.innerHTML = "";

      allStudents.filter(s => (cls === 'all' || s.class === cls) && (s.name.toLowerCase().includes(search) || s.id.includes(search)))
        .sort((a, b) => a.id - b.id).forEach(s => {
          const isPresent = currentLoggedIds.includes(s.id);
          const statusBtn = isPresent
            ? `<button class="btn-danger-light btn-icon-round" onclick="unmark('${s.id}')" title="ยกเลิกการเช็คชื่อ"><i class="ri-close-line"></i></button>`
            : `<button class="btn-primary btn-icon-round" style="background:var(--success)" onclick="markPresent('${s.id}')" title="เช็คชื่อ"><i class="ri-check-double-line"></i></button>`;

          tbody.innerHTML += `<tr>
            <td style="font-weight:600;">${s.id}</td>
            <td>${s.name}</td>
            <td><span class="badge-present" style="background:rgba(99, 102, 241, 0.15); color:var(--primary); border: 1px solid rgba(99, 102, 241, 0.3);">ม.${s.class}</span></td>
            <td style="display:flex; gap:6px; flex-wrap: wrap;">
              <button class="btn-warning btn-icon-round" onclick="startEdit('${s.id}','${s.name}','${s.class}')"><i class="ri-edit-line"></i></button>
              ${statusBtn}
              <button class="btn-danger-light btn-icon-round" onclick="deleteStudent('${s.id}')"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>`;
        });
    };

    window.exportAbsentList = () => {
      if (currentAbsentList.length === 0) return Swal.fire('ข้อมูลว่างเปล่า', 'ไม่มีรายชื่อคนขาดเรียน', 'info');
      let csv = "\uFEFFรหัส,ชื่อ-นามสกุล,ห้อง\n" + currentAbsentList.map(s => `${s.id},${s.name},${s.class}`).join("\n");
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      link.download = `รายงานคนขาด_${document.getElementById("reportDate").value}.csv`;
      link.click();
    };

    window.importCSV = () => {
      const fileInput = document.getElementById('csvFileInput');
      if (!fileInput.files[0]) return Swal.fire('แจ้งเตือน', 'กรุณาเลือกไฟล์ก่อน', 'warning');

      showLoading(true);
      Papa.parse(fileInput.files[0], {
        complete: async (res) => {
          const data = res.data;
          const CHUNK_SIZE = 450;
          let count = 0;

          try {
            for (let i = 0; i < data.length; i += CHUNK_SIZE) {
              const batch = writeBatch(db);
              const chunk = data.slice(i, i + CHUNK_SIZE);
              chunk.forEach(row => {
                if (row[0] && row[1]) {
                  batch.set(doc(db, "students", row[0].toString().trim()), {
                    name: row[1].trim(),
                    class: (row[2] || "6/1").trim()
                  });
                  count++;
                }
              });
              await batch.commit();
            }
            showLoading(false);
            Swal.fire('สำเร็จ', `นำเข้าข้อมูลทั้งหมด ${count} รายการ`, 'success');
          } catch (e) {
            showLoading(false);
            Swal.fire('เกิดข้อผิดพลาด', e.message, 'error');
          }
        }
      });
    };

    // ปรับปรุงการแสดงผลเมื่อเปลี่ยนขนาดหน้าจอ
    window.addEventListener('resize', function() {
      if (window.innerWidth > 1024) {
        closeSidebar();
        document.body.style.overflow = '';
      }
    });

    // ป้องกันการเลื่อนเมื่อแตะที่ sidebar บนมือถือ
    document.querySelector('.sidebar').addEventListener('touchmove', function(e) {
      e.stopPropagation();
    }, { passive: true });

    // Initial State
    document.querySelector('.sidebar').classList.remove('show');
  </script>
</body>

</html>